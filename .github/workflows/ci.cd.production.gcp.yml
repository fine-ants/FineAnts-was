name: CI/CD - GCP Compute Engine Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch to deploy'
        required: true
        default: 'main'

permissions:
  contents: read

env:
  GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
  # Docker Hub Registry ì„¤ì •
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  DOCKER_IMAGE_NAME: fineants-app
  DEPLOY_ENV: production
  # Google Cloud ì„¤ì •
  GCP_INSTANCE_IP: ${{ secrets.GCP_INSTANCE_IP }}
  GCP_SSH_USERNAME: ${{ secrets.GCP_SSH_USERNAME }}
  GCP_SSH_PASSPHRASE: ${{ secrets.GCP_SSH_PASSPHRASE }}
  GCP_SSH_PRIVATE_KEY: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
  GCP_DEPLOY_PATH: /home/${{ secrets.GCP_SSH_USERNAME }}/app

jobs:
  ## 1. CI: ë¹Œë“œ ë° ì´ë¯¸ì§€ ì €ì¥ì†Œ í‘¸ì‹œ
  build-image:
    runs-on: ubuntu-22.04
    environment: gcp-production
    outputs:
      project_version: ${{ steps.get-version.outputs.project_version }}
      image_uri: ${{ steps.set-image-tag.outputs.image_tag }} # ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë¯¸ì§€ URI ì „ë‹¬


    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4.1.7
        with:
          submodules: true
          token: ${{ env.GIT_TOKEN }}
      ## JDK ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4.2.2
        with:
          java-version: '17'
          distribution: 'temurin'
      # gradle caching - ë¹Œë“œ ì‹œê°„ í–¥ìƒ
      - name: Gradle Caching
        uses: actions/cache@v4.2.2
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      # gradlew ì‹¤í–‰ì„ ìœ„í•´ì„œ ì‹¤í–‰ ê¶Œí•œì„ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # Test
      - name: Run Tests
        run: ./gradlew test

      # bootjar
      - name: Build with Gradle
        run: ./gradlew bootJar

      # --- Docker Hub ì¸ì¦ ë° í‘¸ì‹œ
      - name: Get Project Version
        id: get-version
        run: |
          PROJECT_VERSION=$(./gradlew properties | grep "^version:" | awk '{print $2}')
          echo "project_version=$PROJECT_VERSION" >> "$GITHUB_OUTPUT"
          echo "Project Version is $PROJECT_VERSION"

      - name: Set Image Tag
        id: set-image-tag
        run: |
          FULL_TAG="${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DEPLOY_ENV}}-${{ steps.get-version.outputs.project_version }}"
          echo "image_tag=$FULL_TAG" >> "$GITHUB_OUTPUT"
          echo "Full Image Tag is $FULL_TAG"

      - name: Build Docker Image
        run: |
          docker build --platform linux/amd64 \
          --build-arg PROJECT_VERSION=${{ steps.get-version.outputs.project_version }} \
          -t ${{ steps.set-image-tag.outputs.image_tag }} \
          .

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      # í‘¸ì‹œëœ ë¸Œëœì¹˜ê°€ main ë¸Œëœì¹˜ì¸ ê²½ìš° docker latest íƒœê·¸ ì¶”ê°€
      - name: Tag Docker Image as Latest (Conditional)
        if: github.ref == 'refs/heads/main'
        run: |
          LATEST_TAG="${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest"
          docker tag ${{ steps.set-image-tag.outputs.image_tag }} $LATEST_TAG
          echo "Tagged image as latest: $LATEST_TAG"
          # latest íƒœê·¸ í‘¸ì‹œ
          docker push $LATEST_TAG

      - name: Push Docker Image to Docker Hub
        run: docker push ${{ steps.set-image-tag.outputs.image_tag }}
  # 2. CD: GCP Compute Engine SSH ë°°í¬
  deploy:
    runs-on: ubuntu-22.04
    environment: gcp-production
    env:
      IMAGE_TAG: ${{ needs.build-image.outputs.image_uri }}
      ENV_PRODUCTION: ${{ secrets.ENV_PRODUCTION_CONTENT }}
    needs: build-image
    defaults:
      run:
        shell: bash

    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v4.1.7
        with:
          submodules: true
          token: ${{ env.GIT_TOKEN }}
      # í™˜ê²½ ì„¤ì • íŒŒì¼ ë™ì  ìƒì„±
      - name: Create .env.production file from Secret (Conditional)
        # ğŸ’¡ ì¡°ê±´ë¶€ ì‹¤í–‰ì„ ìœ„í•œ run ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì •
        run: |
          # ENV_PRODUCTION ë³€ìˆ˜ê°€ ë¹„ì–´ ìˆì§€ ì•Šì€ ê²½ìš°ì—ë§Œ íŒŒì¼ ìƒì„± ë° ë®ì–´ì“°ê¸° ì‹¤í–‰
          # -n (non-empty) í”Œë˜ê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³€ìˆ˜ê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
          if [[ -n "${{ env.ENV_PRODUCTION }}" ]]; then
            echo "âœ… Creating .env.production from secret..."
            echo "${{ env.ENV_PRODUCTION }}" > .env.production
            ls -al .env.production
          else
            echo "âš ï¸ ENV_PRODUCTION secret is empty. Using existing .env.production file for upload (Local Act Test)."
          fi
      # gcp ssh ì—°ê²° í™•ì¸
      - name: Test SSH Connection
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.GCP_INSTANCE_IP }}
          username: ${{ env.GCP_SSH_USERNAME }}
          passphrase: ${{ env.GCP_SSH_PASSPHRASE }}
          key: ${{ env.GCP_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "SSH connection successful!"
      # docker-compose íŒŒì¼ ë° í•„ìˆ˜ ì„¤ì • íŒŒì¼ VMì— ì—…ë¡œë“œ
      - name: Upload Docker Compose and Files via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.GCP_INSTANCE_IP }}
          username: ${{ env.GCP_SSH_USERNAME }}
          passphrase: ${{ env.GCP_SSH_PASSPHRASE }}
          key: ${{ env.GCP_SSH_PRIVATE_KEY }}
          source: "docker-compose.yml, docker-compose.production.yml, .env.production, redis/" # ì—…ë¡œë“œí•  íŒŒì¼ ëª©ë¡
          target: ${{ env.GCP_DEPLOY_PATH }}
      # ì—…ë¡œë“œëœ íŒŒì¼ í™•ì¸
      - name: check uploaded files
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.GCP_INSTANCE_IP }}
          username: ${{ env.GCP_SSH_USERNAME }}
          passphrase: ${{ env.GCP_SSH_PASSPHRASE }}
          key: ${{ env.GCP_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            ls -al ${{ env.GCP_DEPLOY_PATH }}
      # SSHë¥¼ ì‚¬ìš©í•˜ì—¬ ì›ê²© ì„œë²„ì— ì ‘ì† ë° ë°°í¬ ê³¼ì • ìˆ˜í–‰
      - name: Deploy with Docker Compose via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.GCP_INSTANCE_IP }}
          username: ${{ env.GCP_SSH_USERNAME }}
          passphrase: ${{ env.GCP_SSH_PASSPHRASE }}
          key: ${{ env.GCP_SSH_PRIVATE_KEY }}
          port: 22

          # GCP ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸
          script: |
            # 1. VMì—ì„œ ë°°í¬ í´ë” ìƒì„± ë° ì´ë™
            DEPLOY_DIR=${{ env.GCP_DEPLOY_PATH }}
            echo "Navigating to deployment directory: $DEPLOY_DIR"
            cd $DEPLOY_DIR
            
            # 2. Docker Hub ë¡œê·¸ì¸
            echo "${{ env.DOCKER_PASSWORD }}" | docker login -u "${{ env.DOCKER_USERNAME }}" --password-stdin
            
            # 3. IMAGE_TAG ì²´í¬
            echo "Using IMAGE_TAG: $IMAGE_TAG"
            
            # 3. docker-compose íŒŒì¼ì„ ì‹¤í–‰í•˜ì—¬ ì»¨í…Œì´ë„ˆ ìƒì„± ë° êµì²´ (down, pull, up -d)
            docker-compose -f docker-compose.yml -f docker-compose.production.yml down
            docker-compose -f docker-compose.yml -f docker-compose.production.yml pull
            docker-compose -f docker-compose.yml -f docker-compose.production.yml up -d
